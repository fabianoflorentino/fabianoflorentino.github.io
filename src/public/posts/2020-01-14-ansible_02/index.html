<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Fabiano S. Florentino">
    <meta name="description" content="A alguns dias atrás nosso mestre @gomex abriu uma thread no twitter sobre como é estar desenvolvendo infraestrutura hoje em dia pelo time de Ops Link e como isso é libertador, e de fato, é uma sensação sem igual para um Sysadmin.
Como várias pessoas comentaram eu também não pude deixar de participar. :D,
Na ocasião por coincidência estava desenvolvendo uma imagem de container docker para o ansible!
Mas por quê?">
    <meta name="keywords" content="blog,developer,personal">

    
      <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
    

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Criando um ambiente de desenvolvimento para o Ansible"/>
<meta name="twitter:description" content="A alguns dias atrás nosso mestre @gomex abriu uma thread no twitter sobre como é estar desenvolvendo infraestrutura hoje em dia pelo time de Ops Link e como isso é libertador, e de fato, é uma sensação sem igual para um Sysadmin.
Como várias pessoas comentaram eu também não pude deixar de participar. :D,
Na ocasião por coincidência estava desenvolvendo uma imagem de container docker para o ansible!
Mas por quê?"/>

    <meta property="og:title" content="Criando um ambiente de desenvolvimento para o Ansible" />
<meta property="og:description" content="A alguns dias atrás nosso mestre @gomex abriu uma thread no twitter sobre como é estar desenvolvendo infraestrutura hoje em dia pelo time de Ops Link e como isso é libertador, e de fato, é uma sensação sem igual para um Sysadmin.
Como várias pessoas comentaram eu também não pude deixar de participar. :D,
Na ocasião por coincidência estava desenvolvendo uma imagem de container docker para o ansible!
Mas por quê?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://fabianoflorentino.github.io/posts/2020-01-14-ansible_02/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-01-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-01-14T00:00:00+00:00" />



    
      <base href="https://fabianoflorentino.github.io/posts/2020-01-14-ansible_02/">
    
    <title>
  Criando um ambiente de desenvolvimento para o Ansible · Home
</title>

    
      <link rel="canonical" href="https://fabianoflorentino.github.io/posts/2020-01-14-ansible_02/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css" integrity="sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://fabianoflorentino.github.io/css/coder.min.3219ef62ae52679b7a9c19043171c3cd9f523628c2a65f3ef247ee18836bc90b.css" integrity="sha256-MhnvYq5SZ5t6nBkEMXHDzZ9SNijCpl8&#43;8kfuGINryQs=" crossorigin="anonymous" media="screen" />
    

    

    

    

    

    <link rel="icon" type="image/png" href="https://fabianoflorentino.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://fabianoflorentino.github.io/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.99.1" />
  </head>

  
  
  <body class="colorscheme-light"
        onload=" twemoji.parse(document.body); "
  >
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://fabianoflorentino.github.io/">
      Home
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://fabianoflorentino.github.io/sobre/">Sobre</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://fabianoflorentino.github.io/posts/">Artigos</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Criando um ambiente de desenvolvimento para o Ansible</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2020-01-14T00:00:00Z'>
                January 14, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              10-minute read
            </span>
          </div>
          <div class="categories">
  <i class="fas fa-folder"></i>
    <a href="https://fabianoflorentino.github.io/categories/automa%C3%A7%C3%A3o/">automação</a>
      <span class="separator">•</span>
    <a href="https://fabianoflorentino.github.io/categories/ansible/">ansible</a>
      <span class="separator">•</span>
    <a href="https://fabianoflorentino.github.io/categories/desenvolvimento/">desenvolvimento</a>
      <span class="separator">•</span>
    <a href="https://fabianoflorentino.github.io/categories/container/">container</a></div>

          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="https://fabianoflorentino.github.io/tags/automa%C3%A7%C3%A3o/">automação</a>
      <span class="separator">•</span>
    <a href="https://fabianoflorentino.github.io/tags/ansible/">ansible</a>
      <span class="separator">•</span>
    <a href="https://fabianoflorentino.github.io/tags/desenvolvimento/">desenvolvimento</a>
      <span class="separator">•</span>
    <a href="https://fabianoflorentino.github.io/tags/container/">container</a></div>

        </div>
      </header>

      <div>
        
        <p>A alguns dias atrás nosso mestre <a href="https://gomex.me">@gomex</a> abriu uma thread no twitter sobre como é
estar desenvolvendo infraestrutura hoje em dia pelo time de Ops <a href="https://twitter.com/gomex/status/1215774716138573824?s=21">Link</a> e como isso é libertador, e de fato, é uma sensação sem igual para um Sysadmin.</p>
<p>Como várias pessoas comentaram eu também não pude deixar de participar. :D,</p>
<p>Na ocasião por coincidência estava desenvolvendo uma imagem de container docker para o ansible!</p>
<p>Mas por quê?</p>
<p>A ideia e criar um ambiente centralizado com o ansible instalado sem a necessidade de &ldquo;sujar&rdquo; o seu sistema operacional corrente com várias ferramentas que usamos durante o desenvolvimento de módulos, roles, tasks e tudo que permeia o desenvolvimento.</p>
<p>Nesse artigo vou escrever/descrever uma necessidade própria, então tome esse artigo como um guia e adapte para sua necessidade beleza?! :D</p>
<p>Vamos criar uma estrutura de arquivos e diretórios para desenvolver o projeto.</p>
<p>Crie um diretório qualquer e dentro desse diretório monte a estrutura de arquivos e diretórios proposto abaixo.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir new_hosts
</span></span></code></pre></div><p>No final teremos algo assim.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>new_hosts master 3d ➜ tree -L <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── Dockerfile
</span></span><span style="display:flex;"><span>├── Makefile
</span></span><span style="display:flex;"><span>├── ansible.cfg
</span></span><span style="display:flex;"><span>├── inventory
</span></span><span style="display:flex;"><span>│   ├── group_vars
</span></span><span style="display:flex;"><span>│   │   └── all.yaml
</span></span><span style="display:flex;"><span>│   └── invetory.ini
</span></span><span style="display:flex;"><span>├── requirements.txt
</span></span><span style="display:flex;"><span>├── roles
</span></span><span style="display:flex;"><span>│   └── common
</span></span><span style="display:flex;"><span>│       ├── handlers
</span></span><span style="display:flex;"><span>│       │   └── main.yaml
</span></span><span style="display:flex;"><span>│       ├── tasks
</span></span><span style="display:flex;"><span>│       │   └── main.yaml
</span></span><span style="display:flex;"><span>│       └── templates
</span></span><span style="display:flex;"><span>│           ├── 11-hardening.conf.j2
</span></span><span style="display:flex;"><span>│           └── ntp.conf.j2
</span></span><span style="display:flex;"><span>├── setup.yaml
</span></span><span style="display:flex;"><span>└── ssh-keys
</span></span><span style="display:flex;"><span>    └── ssh-keygen.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">8</span> directories, <span style="color:#ff0;font-weight:bold">12</span> files
</span></span></code></pre></div><h2 id="requisitos">Requisitos</h2>
<ul>
<li>Máquina Virtual
<ul>
<li>Ubuntu Server</li>
<li>SSH</li>
</ul>
</li>
</ul>
<h2 id="dockerfile"><strong>Dockerfile</strong></h2>
<p>Com o dockerfile vamos construir a imagem docker com o ansible instalado para centralizar a execução e desenvolvimento do projeto de automação.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span><span style="color:#0ff;font-weight:bold"> python:3.7-alpine</span><span style="color:#f00">
</span></span></span><span style="display:flex;"><span><span style="color:#f00">
</span></span></span><span style="display:flex;"><span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">COPY</span> requirements.txt .<span style="color:#f00">
</span></span></span><span style="display:flex;"><span><span style="color:#f00">
</span></span></span><span style="display:flex;"><span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">RUN</span> apk add vim make sshpass openssh gcc g++ libffi-dev openssl openssl-dev <span style="color:#0ff;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>  &amp;&amp; adduser --disabled-password --gecos <span style="color:#0ff;font-weight:bold">&#34;&#34;</span> ansible <span style="color:#0ff;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>  &amp;&amp; pip install -r requirements.txt<span style="color:#f00">
</span></span></span><span style="display:flex;"><span><span style="color:#f00">
</span></span></span><span style="display:flex;"><span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">USER</span><span style="color:#0ff;font-weight:bold"> ansible</span><span style="color:#f00">
</span></span></span><span style="display:flex;"><span><span style="color:#f00">
</span></span></span><span style="display:flex;"><span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">WORKDIR</span><span style="color:#0ff;font-weight:bold"> /ansible</span><span style="color:#f00">
</span></span></span><span style="display:flex;"><span><span style="color:#f00">
</span></span></span><span style="display:flex;"><span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">ENTRYPOINT</span> [ <span style="color:#0ff;font-weight:bold">&#34;sh&#34;</span> ]<span style="color:#f00">
</span></span></span></code></pre></div><h2 id="makefile"><strong>Makefile</strong></h2>
<p>Com o <a href="https://www.gnu.org/software/make/manual/make.html">make</a> criamos uma forma de centralizar e automatizar os comandos que utilizamos repetidas vezes ao longo do desenvolvimento.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span>.PHONY: help
</span></span><span style="display:flex;"><span>.DEFAULT_GOAL := <span style="color:#fff;font-weight:bold">help</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>help:
</span></span><span style="display:flex;"><span>	@grep -E <span style="color:#0ff;font-weight:bold">&#39;^[0-9a-zA-Z_-]+:.*?## .*$$&#39;</span> <span style="color:#fff;font-weight:bold">$(</span>MAKEFILE_LIST<span style="color:#fff;font-weight:bold">)</span> | awk <span style="color:#0ff;font-weight:bold">&#39;BEGIN {FS = &#34;:.*?## &#34;}; {printf &#34;\033[36m%-25s\033[0m %s\n&#34;, $$1, $$2, $$3, $$4, $$5}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build: <span style="color:#007f7f">## Make image for use terraform
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	@docker build --no-cache -t fabianoflorentino/ansible .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>run: <span style="color:#007f7f">## Start Terraform
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	@docker run -it --name ansible -v <span style="color:#0ff;font-weight:bold">${</span>PWD<span style="color:#0ff;font-weight:bold">}</span>:/ansible --entrypoint <span style="color:#0ff;font-weight:bold">&#34;&#34;</span> fabianoflorentino/ansible sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rm: <span style="color:#007f7f">## Remove container
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	@docker container rm -f ansible
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rmi: <span style="color:#007f7f">## Remove untagged images
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	@docker rmi -f <span style="color:#fff;font-weight:bold">$(</span>docker images | grep <span style="color:#0ff;font-weight:bold">&#34;^&lt;none&gt;&#34;</span> |cut -d<span style="color:#0ff;font-weight:bold">&#34; &#34;</span> -f50<span style="color:#fff;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible-test: <span style="color:#007f7f">## Test of ansible roles to apply
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	@ansible-playbook -i inventory/invetory.ini -u supervisor -b -e ssh_connection_user=supervisor setup.yaml -C
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible-run: <span style="color:#007f7f">## Test of ansible roles to apply
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	@ansible-playbook -i inventory/invetory.ini -u supervisor -b -e ssh_connection_user=supervisor setup.yaml
</span></span></code></pre></div><h2 id="ansiblecfg"><strong>ansible.cfg</strong></h2>
<p>Nesse arquivo determinamos alguns parametros para melhorar a execução do ansible.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">[defaults]</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">gathering</span> = <span style="color:#0ff;font-weight:bold">smart</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">forks</span>               = <span style="color:#0ff;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">callback_whitelist</span>  = <span style="color:#0ff;font-weight:bold">timer, mail, profile_tasks</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">host_key_checking</span>   = <span style="color:#0ff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">fact_caching_connection</span> = <span style="color:#0ff;font-weight:bold">/tmp/facts_cache</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">fact_caching</span> = <span style="color:#0ff;font-weight:bold">jsonfile</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">fact_caching_timeout</span> = <span style="color:#0ff;font-weight:bold">7200</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">gather_subset</span>=<span style="color:#0ff;font-weight:bold">!hardware</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">error_on_missing_handler</span> = <span style="color:#0ff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">sudo_flags</span> = <span style="color:#0ff;font-weight:bold">-H -S -n</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">[ssh_connection]</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">ssh_args</span>     = <span style="color:#0ff;font-weight:bold">-C -o ControlMaster=auto -o ControlPersist=18000</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">control_path</span> = <span style="color:#0ff;font-weight:bold">%(directory)s/ansible-ssh-%%h-%%p-%%r</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">pipelining</span>   = <span style="color:#0ff;font-weight:bold">True</span>
</span></span></code></pre></div><h2 id="inventory"><strong>inventory</strong></h2>
<p>Diretório onde configuramos os hosts que serão gerenciados pelo ansible.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -p inventory/group_vars
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>├── inventory
</span></span><span style="display:flex;"><span>│   ├── group_vars
</span></span></code></pre></div><h3 id="allyaml"><strong>all.yaml</strong></h3>
<p>Aqui determinamos algumas variáveis que será utilizada pelo group de hosts <strong>[all]</strong> que fica no arquivo <strong>inventory.ini</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim inventory/group_vars/all.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>├── inventory
</span></span><span style="display:flex;"><span>│   ├── group_vars
</span></span><span style="display:flex;"><span>│   │   └── all.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">packages</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">to_install</span>:
</span></span><span style="display:flex;"><span>    - vim
</span></span><span style="display:flex;"><span>    - tree
</span></span><span style="display:flex;"><span>    - netcat
</span></span><span style="display:flex;"><span>    - tcpdump
</span></span><span style="display:flex;"><span>    - nmap
</span></span><span style="display:flex;"><span>    - ntp
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">to_remove</span>:
</span></span><span style="display:flex;"><span>    -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">services</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">to_enable</span>:
</span></span><span style="display:flex;"><span>    - ntp
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">to_disable</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">ntp_servers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#0ff;font-weight:bold">&#34;server 0.br.pool.ntp.org&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#0ff;font-weight:bold">&#34;server 1.br.pool.ntp.org&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#0ff;font-weight:bold">&#34;server 2.br.pool.ntp.org&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#0ff;font-weight:bold">&#34;server 3.br.pool.ntp.org&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">hardening</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">net_ipv6_conf_all_disable_ipv6</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">net_ipv6_conf_default_disable_ipv6</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">net_ipv6_conf_lo_disable_ipv6</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">net_ipv4_conf_all_accept_source_route</span>: <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">ipv4_conf_all_forwarding</span>: <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">net_ipv4_conf_all_accept_redirects</span>: <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">net_ipv4_conf_all_secure_redirects</span>: <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">net_ipv4_conf_all_send_redirects</span>: <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">net_ipv4_conf_all_rp_filter</span>: <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">net_ipv4_icmp_echo_ignore_all</span>: <span style="color:#ff0;font-weight:bold">0</span>
</span></span></code></pre></div><h3 id="inventoryini"><strong>inventory.ini</strong></h3>
<p>Arquivo com os hosts e grupo de hosts que o ansible irá gerenciar.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim invetory/inventory.ini
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>├── inventory
</span></span><span style="display:flex;"><span>│   └── invetory.ini
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">[all]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vm-1 ansible_host</span>=<span style="color:#0ff;font-weight:bold">192.168.7.100</span>
</span></span></code></pre></div><h3 id="requirementstxt"><strong>requirements.txt</strong></h3>
<p>Lista com os módulos que serão instalados junto com o ansible para o funcionamento adequado.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span># Note: this requirements.txt file is used to specify what dependencies are
</span></span><span style="display:flex;"><span># needed to make the package run rather than for deployment of a tested set of
</span></span><span style="display:flex;"><span># packages.  Thus, this should be the loosest set possible (only required
</span></span><span style="display:flex;"><span># packages, not optional ones, and with the widest range of versions that could
</span></span><span style="display:flex;"><span># be suitable)
</span></span><span style="display:flex;"><span>crypto
</span></span><span style="display:flex;"><span>cryptography
</span></span><span style="display:flex;"><span>ansible
</span></span></code></pre></div><h2 id="roles"><strong>roles</strong></h2>
<p>Diretório com o conjunto de roles/tasks que o ansible irá aplicar nos hosts gerenciados.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>├── roles
</span></span><span style="display:flex;"><span>│   └── common
</span></span><span style="display:flex;"><span>│       ├── handlers
</span></span><span style="display:flex;"><span>│       │   └── main.yaml
</span></span><span style="display:flex;"><span>│       ├── tasks
</span></span><span style="display:flex;"><span>│       │   └── main.yaml
</span></span><span style="display:flex;"><span>│       └── templates
</span></span><span style="display:flex;"><span>│           ├── 11-hardening.conf.j2
</span></span><span style="display:flex;"><span>│           └── ntp.conf.j2
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -p roles/common/{tasks,handlers,templates}
</span></span></code></pre></div><p>O diretório <strong>common</strong> é a role e conjunto de tasks que iremos utilizar para executar o projeto no host(vm) de desenvolvimento.</p>
<h3 id="tasks---mainyaml"><strong>tasks - main.yaml</strong></h3>
<p>Conjunto de tasks que será executada nos hosts gerenciados pelo ansible.</p>
<ul>
<li>&ldquo;Update System&rdquo;</li>
<li>&ldquo;Install Essential Packages&rdquo;</li>
<li>&ldquo;Enable Essential Services&rdquo;</li>
<li>&ldquo;Configure NTP service&rdquo;</li>
<li>&ldquo;Hardening - Kernel Parameters&rdquo;</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim roles/common/tasks/main.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>├── roles
</span></span><span style="display:flex;"><span>│   └── common
</span></span><span style="display:flex;"><span>│       ├── tasks
</span></span><span style="display:flex;"><span>│       │   └── main.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="font-weight:bold">name</span>: <span style="color:#0ff;font-weight:bold">&#34;Update System&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">package</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">state</span>: latest
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: <span style="color:#0ff;font-weight:bold">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="font-weight:bold">name</span>: <span style="color:#0ff;font-weight:bold">&#34;Install Essential Packages&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">apt</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">state</span>: present
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: <span style="color:#0ff;font-weight:bold">&#34;{{ item }}&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">loop</span>: <span style="color:#0ff;font-weight:bold">&#34;{{ packages.to_install }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="font-weight:bold">name</span>: <span style="color:#0ff;font-weight:bold">&#34;Enable Essential Services&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">apt</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">state</span>: present
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: <span style="color:#0ff;font-weight:bold">&#34;{{ item }}&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">loop</span>: <span style="color:#0ff;font-weight:bold">&#34;{{ services.to_enable }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="font-weight:bold">name</span>: <span style="color:#0ff;font-weight:bold">&#34;Configure NTP service&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">template</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">src</span>: ntp.conf.j2
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">dest</span>: /etc/ntp.conf
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">owner</span>: root
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">mode</span>: <span style="color:#ff0;font-weight:bold">0644</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">notify</span>: <span style="color:#0ff;font-weight:bold">&#34;Restart NTP service&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="font-weight:bold">name</span>: <span style="color:#0ff;font-weight:bold">&#34;Hardening - Kernel Parameters&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">template</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">src</span>: <span style="color:#ff0;font-weight:bold">11</span>-hardening.conf.j2
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">dest</span>: /etc/sysctl.d/11-hardening.conf
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">owner</span>: root
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">group</span>: root
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">mode</span>: <span style="color:#ff0;font-weight:bold">0644</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">notify</span>: <span style="color:#0ff;font-weight:bold">&#34;Apply Kernel Parameters&#34;</span>
</span></span></code></pre></div><h3 id="templates"><strong>templates</strong></h3>
<p>Arquivos templates com variáveis para criar os arquivos de configuração dinamicamente.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>├── roles
</span></span><span style="display:flex;"><span>│   └── common
</span></span><span style="display:flex;"><span>│       └── templates
</span></span><span style="display:flex;"><span>│           ├── 11-hardening.conf.j2
</span></span><span style="display:flex;"><span>│           └── ntp.conf.j2
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim roles/common/templates/11-hardening.conf.j2
</span></span></code></pre></div><ul>
<li>
<h3 id="11-hardeningconf"><strong>11-hardening.conf</strong></h3>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jinja" data-lang="jinja"><span style="display:flex;"><span># <span style="color:#0f0;font-weight:bold">{{</span> ansible_managed <span style="color:#0f0;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ipv4.conf.all.forwarding = <span style="color:#0f0;font-weight:bold">{{</span> hardening.ipv4_conf_all_forwarding<span style="color:#0f0;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>net.ipv4.conf.all.accept_source_route = <span style="color:#0f0;font-weight:bold">{{</span> hardening.net_ipv4_conf_all_accept_source_route<span style="color:#0f0;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>net.ipv4.conf.all.accept_redirects = <span style="color:#0f0;font-weight:bold">{{</span> hardening.net_ipv4_conf_all_accept_redirects <span style="color:#0f0;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>net.ipv4.conf.all.secure_redirects = <span style="color:#0f0;font-weight:bold">{{</span> hardening.net_ipv4_conf_all_secure_redirects <span style="color:#0f0;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>net.ipv4.conf.all.send_redirects = <span style="color:#0f0;font-weight:bold">{{</span> hardening.net_ipv4_conf_all_send_redirects <span style="color:#0f0;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>net.ipv4.conf.all.rp_filter = <span style="color:#0f0;font-weight:bold">{{</span> hardening.net_ipv4_conf_all_rp_filter <span style="color:#0f0;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>net.ipv4.icmp_echo_ignore_all = <span style="color:#0f0;font-weight:bold">{{</span> hardening.net_ipv4_icmp_echo_ignore_all <span style="color:#0f0;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>net.ipv6.conf.all.disable_ipv6 = <span style="color:#0f0;font-weight:bold">{{</span> hardening.net_ipv6_conf_all_disable_ipv6 <span style="color:#0f0;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>net.ipv6.conf.default.disable_ipv6 = <span style="color:#0f0;font-weight:bold">{{</span> hardening.net_ipv6_conf_default_disable_ipv6<span style="color:#0f0;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>net.ipv6.conf.lo.disable_ipv6 = <span style="color:#0f0;font-weight:bold">{{</span> hardening.net_ipv6_conf_lo_disable_ipv6 <span style="color:#0f0;font-weight:bold">}}</span>
</span></span></code></pre></div><ul>
<li>
<h3 id="ntpconf"><strong>ntp.conf</strong></h3>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim roles/common/templates/ntp.conf.j2
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jinja" data-lang="jinja"><span style="display:flex;"><span>#
</span></span><span style="display:flex;"><span># <span style="color:#0f0;font-weight:bold">{{</span> ansible_managed <span style="color:#0f0;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>#
</span></span><span style="display:flex;"><span># For more information about this file, see the man pages
</span></span><span style="display:flex;"><span># ntp.conf(5), ntp_acc(5), ntp_auth(5), ntp_clock(5), ntp_misc(5), ntp_mon(5).
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>driftfile /var/lib/ntp/drift
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Permit time synchronization with our time source, but do not
</span></span><span style="display:flex;"><span># permit the source to query or modify the service on this system.
</span></span><span style="display:flex;"><span>restrict default nomodify notrap nopeer noquery
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Permit all access over the loopback interface.  This could
</span></span><span style="display:flex;"><span># be tightened as well, but to do so would effect some of
</span></span><span style="display:flex;"><span># the administrative functions.
</span></span><span style="display:flex;"><span>restrict 127.0.0.1
</span></span><span style="display:flex;"><span>restrict ::1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Hosts on local network are less restricted.
</span></span><span style="display:flex;"><span>#restrict 192.168.1.0 netmask 255.255.255.0 nomodify notrap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Use public servers from the pool.ntp.org project.
</span></span><span style="display:flex;"><span># Please consider joining the pool (http://www.pool.ntp.org/join.html).
</span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">{%</span> <span style="color:#fff;font-weight:bold">for</span> server <span style="color:#fff;font-weight:bold">in</span> ntp_servers <span style="color:#0f0;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">{{</span> server <span style="color:#0f0;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">{%</span> <span style="color:#fff;font-weight:bold">endfor</span> <span style="color:#0f0;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logfile /var/log/ntp.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#broadcast 192.168.1.255 autokey        # broadcast server
</span></span><span style="display:flex;"><span>#broadcastclient                        # broadcast client
</span></span><span style="display:flex;"><span>#broadcast 224.0.1.1 autokey            # multicast server
</span></span><span style="display:flex;"><span>#multicastclient 224.0.1.1              # multicast client
</span></span><span style="display:flex;"><span>#manycastserver 239.255.254.254         # manycast server
</span></span><span style="display:flex;"><span>#manycastclient 239.255.254.254 autokey # manycast client
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Enable public key cryptography.
</span></span><span style="display:flex;"><span>#crypto
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>includefile /etc/ntp/crypto/pw
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Key file containing the keys and key identifiers used when operating
</span></span><span style="display:flex;"><span># with symmetric key cryptography.
</span></span><span style="display:flex;"><span>keys /etc/ntp/keys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Specify the key identifiers which are trusted.
</span></span><span style="display:flex;"><span>#trustedkey 4 8 42
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Specify the key identifier to use with the ntpdc utility.
</span></span><span style="display:flex;"><span>#requestkey 8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Specify the key identifier to use with the ntpq utility.
</span></span><span style="display:flex;"><span>#controlkey 8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Enable writing of statistics records.
</span></span><span style="display:flex;"><span>#statistics clockstats cryptostats loopstats peerstats
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Disable the monitoring facility to prevent amplification attacks using ntpdc
</span></span><span style="display:flex;"><span># monlist command when default restrict does not include the noquery flag. See
</span></span><span style="display:flex;"><span># CVE-2013-5211 for more details.
</span></span><span style="display:flex;"><span># Note: Monitoring will not be disabled with the limited restriction flag.
</span></span><span style="display:flex;"><span>disable monitor
</span></span></code></pre></div><h3 id="handlers"><strong>handlers</strong></h3>
<p>Tarefas configuradas para serem re-executadas caso tenha alguma alteração nas configurações das tasks.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>├── roles
</span></span><span style="display:flex;"><span>│   └── common
</span></span><span style="display:flex;"><span>│       ├── handlers
</span></span><span style="display:flex;"><span>│       │   └── main.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim roles/common/handlers/main.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="font-weight:bold">name</span>: <span style="color:#0ff;font-weight:bold">&#34;Restart NTP service&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">systemd</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: ntp
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">state</span>: restarted
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">enabled</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="font-weight:bold">name</span>: <span style="color:#0ff;font-weight:bold">&#34;Apply Kernel Parameters&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">shell</span>: |<span style="color:#0ff;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    </span>    sysctl --system
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">register</span>: kernel_parameters
</span></span></code></pre></div><h3 id="setupyaml"><strong>setup.yaml</strong></h3>
<p>Playbook que executa o conjuntos de roles que será aplicado nos hosts(vm&rsquo;s) gerenciados pelo ansible.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>new_hosts master 3d ➜ tree -L <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── setup.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim new_hosts/setup.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="font-weight:bold">name</span>: <span style="color:#0ff;font-weight:bold">&#34;Prepare new Server&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">hosts</span>:
</span></span><span style="display:flex;"><span>    - all
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">roles</span>:
</span></span><span style="display:flex;"><span>    - {<span style="font-weight:bold">role: common, tags</span>: common}
</span></span></code></pre></div><h3 id="ssh-keys"><strong>ssh-keys</strong></h3>
<p>O ansible faz o gerenciamentos dos hosts através de comunicação ssh para todos os sistemas que o suportam.</p>
<p>A título de curiosidade no windows ele cria uma comunicação do tipo <a href="https://pt.wikipedia.org/wiki/Chamada_de_procedimento_remoto">RPC(Chamada de Procedimento Remoto)</a></p>
<p>Criei esse script para gerar o par de chaves ssh que o ansible irá utilizar no container para gerenciar os hosts de destino.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>new_hosts master 3d ➜ tree -L <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>└── ssh-keys
</span></span><span style="display:flex;"><span>    └── ssh-keygen.sh
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim ssh-keys/ssh-keygen.sh
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#!/usr/bin/env sh
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>mkdir /home/ansible/.ssh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh-keygen -t rsa -N <span style="color:#0ff;font-weight:bold">&#39;&#39;</span> -f ./ssh-keys/ansible -C ansible@dev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cp -rf ./ssh-keys/ansible /home/ansible/.ssh/id_rsa
</span></span><span style="display:flex;"><span>cp -rf ./ssh-keys/ansible.pub /home/ansible/.ssh/id_rsa.pub
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chmod <span style="color:#ff0;font-weight:bold">400</span> /home/ansible/.ssh/id_rsa
</span></span><span style="display:flex;"><span>chmod <span style="color:#ff0;font-weight:bold">644</span> /home/ansible/.ssh/id_rsa.pub
</span></span></code></pre></div><p>Ufa!</p>
<p>Depois de montar toda a nossa estrutura, acredito que temos algo assim</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── Dockerfile
</span></span><span style="display:flex;"><span>├── Makefile
</span></span><span style="display:flex;"><span>├── ansible.cfg
</span></span><span style="display:flex;"><span>├── inventory
</span></span><span style="display:flex;"><span>│   ├── group_vars
</span></span><span style="display:flex;"><span>│   │   └── all.yaml
</span></span><span style="display:flex;"><span>│   └── invetory.ini
</span></span><span style="display:flex;"><span>├── requirements.txt
</span></span><span style="display:flex;"><span>├── roles
</span></span><span style="display:flex;"><span>│   └── common
</span></span><span style="display:flex;"><span>│       ├── handlers
</span></span><span style="display:flex;"><span>│       │   └── main.yaml
</span></span><span style="display:flex;"><span>│       ├── tasks
</span></span><span style="display:flex;"><span>│       │   └── main.yaml
</span></span><span style="display:flex;"><span>│       └── templates
</span></span><span style="display:flex;"><span>│           ├── 11-hardening.conf.j2
</span></span><span style="display:flex;"><span>│           └── ntp.conf.j2
</span></span><span style="display:flex;"><span>├── setup.yaml
</span></span><span style="display:flex;"><span>└── ssh-keys
</span></span><span style="display:flex;"><span>    └── ssh-keygen.sh
</span></span></code></pre></div><h2 id="build"><strong>Build</strong></h2>
<p>No mesmo nível onde está o nosso dockerfile vamos construir a imagem com o ansible instalado.</p>
<p>Lembra do Makefile? então, vamos utilizar bastente ele agora.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>make <span style="color:#fff;font-weight:bold">help</span>
</span></span></code></pre></div><p><img src="../../images/img20.png" alt="&lt;&gt;"></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>make build
</span></span></code></pre></div><p>Esse commando está fazendo o mesmo que:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker build --no-cache -t fabianoflorentino/ansible .
</span></span></code></pre></div><p>Melhor né? :D, automação da automação!</p>
<p>e assim para todos os comandos que iremos utilizar, para verificar a sintaxe dos comandos volta lá no arquivo Makefile e veja o que cada comando está executando beleza? :D</p>
<p>No final se tudo ocorreu bem teremos a seguinte mensagem:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Successfully built 3894bf22ae0d
</span></span><span style="display:flex;"><span>Successfully tagged fabianoflorentino/ansible:latest
</span></span></code></pre></div><p><img src="../../images/img21.png" alt="&lt;&gt;"></p>
<h2 id="ansible"><strong>Ansible</strong></h2>
<p>Com a imagem pronta vamos iniciar o container para utilizamos o ansible de forma isolada em um container mas interagindo com o nosso projeto.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>make run
</span></span></code></pre></div><p><img src="../../images/img22.png" alt="&lt;&gt;"></p>
<p>Como de dentro do container estamos conseguindo acessar os arquivos do projeto?</p>
<p>A forma como estamos executando o container. Na execução estamos montando o diretório corrente dentro do container e acessamos o container através do shell sh.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run -it --name ansible -v <span style="color:#0ff;font-weight:bold">${</span>PWD<span style="color:#0ff;font-weight:bold">}</span>:/ansible --entrypoint <span style="color:#0ff;font-weight:bold">&#34;&#34;</span> fabianoflorentino/ansible sh
</span></span></code></pre></div><h2 id="ssh"><strong>SSH</strong></h2>
<p>De dentro do container execute o script que cria o par de chaves ssh para comunicação com os hosts.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sh ssh-keys/ssh-keygen.sh
</span></span></code></pre></div><p><img src="../../images/img23.png" alt="&lt;&gt;"></p>
<p>Transfira a chave ssh publica para o(s) host(s) que serão gerenciados.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh-copy-id -i /home/ansible/.ssh/id_rsa.pub supervisor@192.168.7.100
</span></span></code></pre></div><p><img src="../../images/img24.png" alt="&lt;&gt;"></p>
<p>Teste a comunicação com o(s) host(s)</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ansible -i inventory/invetory.ini all -u supervisor -b -m ping
</span></span></code></pre></div><p><img src="../../images/img25.png" alt="&lt;&gt;"></p>
<h2 id="deploy-da-vm"><strong>Deploy da VM</strong></h2>
<p>Com a comunicação estabelecida podemos aplicar a(s) roles que foi desenvolvida nesse projeto no caso a role <strong>common</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>make ansible-test
</span></span></code></pre></div><p>Esse comando irá fazer o teste de execução das tasks.</p>
<p><img src="../../images/img26.png" alt="&lt;&gt;"></p>
<p>O que estiver em amarelo o ansible irá executar a alteração o que estiver em verde é porque a ação esperada já foi executada ou está de acordo com a task.</p>
<p>Feito o teste, podemos aplicar realmente as alterações no host(s)</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>make ansible-run
</span></span></code></pre></div><p><img src="../../images/img27.png" alt="&lt;&gt;"></p>
<h2 id="idempotência"><strong>Idempotência</strong></h2>
<p>Uma boa prática é sempre buscar <a href="https://pt.wikipedia.org/wiki/Idempot%C3%AAncia">Idempotência</a> na execução da sua gerencia de configuração, uma vez aplicada aquele conjunto de configuração ele só poderá ser modificado caso aja modificação no código do seu projeto, do contrário não importa quantas vezes você executar o ansible, ele sempre terá que aplicar as mesmas configurações previamente configuradas.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>make ansible-run
</span></span></code></pre></div><p><img src="../../images/img28.png" alt="&lt;&gt;"></p>
<h2 id="demo"><strong>Demo</strong></h2>
<p><a href="https://youtu.be/knIVwuF16zI" title="Criando um ambiente de desenvolvimento para o Ansible"><img src="https://img.youtube.com/vi/knIVwuF16zI/0.jpg" alt="&lt;"></a></p>
<h2 id="conclusão"><strong>Conclusão</strong></h2>
<p>Como mencionanei no começo do artigo o <a href="https://gomex.me">@gomex</a> iniciou um thread muito bacana sobre como nós antigos Sysadmin(Ops) agora SRE&rsquo;s, DevOps Engineer, Eng. DevOps e afins não importa o nome, temos a satisfação de estar entregando infraestrutura como código, criando ambiente de desenvolvimento como o citado ao longo desse artigo.</p>
<p>É muito legal ver uma área admirada por muitos no mundo de tecnologia se transformar radicalmente. Bom,espero ajudar bastante gente com esse artigo.</p>
<p>Ah! ia me esquecendo, parte do que demonstrei aqui com o Makefile aprendi pertubando muito o <a href="http://igordcsouza.github.io/">@igorsouza</a> vlw d++ mano :D!</p>
<p><strong>Projeto:</strong> <a href="http://bit.ly/2Ns2ZRs">http://bit.ly/2Ns2ZRs</a></p>

      </div>


      <footer>
        


        <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "florentinocodar" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
        
      </footer>
    </article>

    
  </section>

      </div>

      
  <footer class="footer">
    <section class="container">
      
      
        
        
          
        
        
        
      
      
        
        
      
      
        
      
    </section>
  </footer>

    </main>

    

    

    <script>
(function(f, a, t, h, o, m){
	a[h]=a[h]||function(){
		(a[h].q=a[h].q||[]).push(arguments)
	};
	o=f.createElement('script'),
	m=f.getElementsByTagName('script')[0];
	o.async=1; o.src=t; o.id='fathom-script';
	m.parentNode.insertBefore(o,m)
})(document, window, '//analytics.example.com/tracker.js', 'fathom');
fathom('set', 'siteId', 'ABCDE');
fathom('trackPageview');
</script>


  </body>

</html>
